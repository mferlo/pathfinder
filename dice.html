<html>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<head>

<style>
    .die-count { font-weight: bold; }
</style>

<script language="javascript" type="text/javascript">
function asNum(id) {
    return +(document.getElementById(id).innerText);
}

function adj(elementId, value, canGoNegative) {
    var ele = document.getElementById(elementId);

    var before = asNum(elementId);
    var after = before + value;

    if (canGoNegative || after >= 0) {
        ele.innerText = after;
    }
}

function adjNum(elementId, value) {
    var ele = document.getElementById(elementId);
	// Doesn't work in IE. Meh.
    ele.valueAsNumber = ele.valueAsNumber + value;
}

function oneTo(max) {
    var a = Array.from(Array(max + 1).keys());
    a.shift();
    return a;
}

function dice() {
	return [
		'd4-count',
		'd6-count',
		'd8-count',
		'd10-count',
		'd12-count',
		'd20-count',
		'static-value'
	];
}

window.onload = loadState;

function saveState() {
	dice().forEach(d => document.cookie = `${d}=${asNum(d)}`);

	var targetValue = document.getElementById('target-value').value;
	document.cookie = `target-value=${targetValue}`;
}

function fromCookie(id) {
	var re = new RegExp(`${id}=(\\w+)`);
	var match = document.cookie.match(re);
	return match ? match[1] : 0;
}

function loadState() {
	// "foo=bar; baz=qux" => "{'foo':'bar','baz':'qux'}"
	dice().forEach(id =>
		document.getElementById(id).innerText = fromCookie(id));

	document.getElementById('target-value').value = fromCookie('target-value');
}

function addDice(dice, maxDieValue) {
    var numDice = asNum(`d${maxDieValue}-count`);
    for (var i = 0; i < numDice; i++) {
        dice.push(oneTo(maxDieValue));
    }
}

function assembleDice() {
    var sizes = [ 4, 6, 8, 10, 12, 20 ];
    var dice = [];
    sizes.forEach(size => addDice(dice, size));
	return dice;
}

function incr(totalDice, indexes) {
	// Try to increment the "right-most" element.
	// If it's at max, "carry" to the one on the left.
    var i = indexes.length - 1;
    while (i >= 0) {
        var max = totalDice[i].length - 1;
        if (indexes[i] < max) {
            indexes[i] += 1;
            return true;
        }

        indexes[i] = 0;
        i -= 1;
    }
    return false;
}

function getAllPossibleResults(dice) {
    var diceIndexes = Array(dice.length).fill(0);
    var results = {};
    var staticBonus = asNum('static-value');

    do {
        var result = staticBonus;
        for (var i = 0; i < dice.length; i++) {
            var dieIndex = diceIndexes[i];
            result += dice[i][dieIndex];
        }
        results[result] = 1 + (results[result] || 0);
    } while (incr(dice, diceIndexes));

	return results;
}

function displayResults(resultsCount) {
    var target = document.getElementById('target-value').valueAsNumber;

	var results = Object.keys(resultsCount).sort((a, b) => a - b);
	console.log(results);

    var outcome = document.getElementById('outcome');
	if (results[0] >= target) {
        outcome.innerText = "Automatic";
	} else if (results[results.length - 1] < target) {
		outcome.innerText = "Impossible";
	} else {
		var total = 0;
		results.forEach(r => total += resultsCount[r]);
		var successes = 0;
		results.filter(r => r >= target).forEach(r => successes += resultsCount[r]);
        outcome.innerText =
			`${Math.trunc(100 * successes / total)}% (${successes}/${total})`;
    }
}

function roll() {
	saveState();
	var dice = assembleDice();
	var results = getAllPossibleResults(dice);
	displayResults(results);
}

</script>
</head>

<body>

  <div id="static">
    <button id="static-dec" onclick="adj('static-value', -1, true)" class="decr">-</button>
    /
    <button id="static-inc" onclick="adj('static-value', 1, true)" class="incr">+</button>
    <span id="static-value" class="die-count">3</span>
    static
  </div>

  <div id="d4">
    <button id="d4-dec" onclick="adj('d4-count', -1)" class="decr">-</button>
    /
    <button id="d4-inc" onclick="adj('d4-count', 1)" class="incr">+</button>
    <span id="d4-count" class="die-count">0</span>
    d4
  </div>

  <div id="d6">
    <button id="d6-dec" onclick="adj('d6-count', -1)" class="decr">-</button>
    /
    <button id="d6-inc" onclick="adj('d6-count', 1)" class="incr">+</button>
    <span id="d6-count" class="die-count">0</span>
    d6
  </div>

  <div id="d8">
    <button id="d8-dec" onclick="adj('d8-count', -1)" class="decr">-</button>
    /
    <button id="d8-inc" onclick="adj('d8-count', 1)" class="incr">+</button>
    <span id="d8-count" class="die-count">0</span>
    d8
  </div>

  <div id="d10">
    <button id="d10-dec" onclick="adj('d10-count', -1)" class="decr">-</button>
    /
    <button id="d10-inc" onclick="adj('d10-count', 1)" class="incr">+</button>
    <span id="d10-count" class="die-count">0</span>
    d10
  </div>

  <div id="d12">
    <button id="d12-dec" onclick="adj('d12-count', -1)" class="decr">-</button>
    /
    <button id="d12-inc" onclick="adj('d12-count', 1)" class="incr">+</button>
    <span id="d12-count" class="die-count">0</span>
    d12
  </div>

  <div id="d20">
    <button id="d20-dec" onclick="adj('d20-count', -1)" class="decr">-</button>
    /
    <button id="d20-inc" onclick="adj('d20-count', 1)" class="incr">+</button>
    <span id="d20-count" class="die-count">0</span>
    d20
  </div>

  <br />

  <div id="target">
    <button id="target-dec" onclick="adjNum('target-value', -1)" class="decr">-</button>
    /
    <button id="target-inc" onclick="adjNum('target-value', 1)" class="incr">+</button>
    <input id="target-value" type="number" min="0" max="99" style="width: 4em;" value="8" />
    target
  </div>

  <br />

  <div id="result">
    <button id="roll" onclick="roll()">Roll</button>
    <span id="outcome"></span>
  </div>

</body>

</html>
